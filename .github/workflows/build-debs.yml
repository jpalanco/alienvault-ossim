name: Build and Deploy DEB Packages

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository code.
      - name: Checkout Repository
        uses: actions/checkout@v2

      # 2. Build the DEB packages on Debian Stretch.
      # This step runs a container based on debian:stretch.
      # It modifies the apt sources to use archive.debian.org,
      # enables deb-src lines, removes any "stretch-updates" entries,
      # installs the necessary build tools (including devscripts),
      # then iterates through directories containing a "debian" folder and runs dpkg-buildpackage.
      - name: Build DEB Packages on Stretch
        run: |
          echo "Running build in custom container..."
          docker run --rm -v "$PWD":/workspace debian:stretch bash -c "\
            # Enable source repositories by uncommenting deb-src lines
            sed -i 's/^# deb-src/deb-src/' /etc/apt/sources.list && \
            # Replace repository URLs with archive URLs for Stretch
            sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list && \
            sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list && \
            # Remove any stretch-updates lines to avoid 404 errors
            sed -i '/stretch-updates/d' /etc/apt/sources.list && \
            # Disable the Check-Valid-Until option (required for archived repos)
            echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid-until && \
            apt-get update && \
            # Install required build tools (dpkg-buildpackage is provided by devscripts)
            apt-get install -y build-essential devscripts debhelper dpkg-dev apt-utils && \
            for pkg in \$(find . -type d -name debian -printf '%h\n' | sort -u); do \
              echo '-----------------------------'; \
              echo \"Building package in: \$pkg\"; \
              cd \$pkg; \
              if [ -f debian/control ]; then \
                dpkg-buildpackage -uc -us || echo \"⚠️  Build failed in \$pkg\"; \
              else \
                echo \"No debian/control file found in \$pkg, skipping...\"; \
              fi; \
              cd - > /dev/null; \
            done"
        id: build

      # 3. Upload all generated .deb files as an artifact for use in the deploy job.
      - name: Upload DEB Files Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: "*.deb"

  deploy:
    needs: build-deb
    runs-on: ubuntu-latest
    steps:
      # 4. Download the artifact generated in the build job.
      - name: Download DEB Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: output

      # 5. Generate the APT repository index file (Packages.gz) in the output directory.
      - name: Create APT Repository Index
        run: |
          cd output
          echo "Generating Packages.gz index..."
          dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
          ls -la
          cd ..

      # 6. Deploy the output folder to GitHub Pages.
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: output

